import { ChangeDetectionStrategy, Component, Input } from '@angular/core';
import {
  IAddEventData,
  ICalendarAction,
  ICalendarEvent,
  IDateRange,
  ITimeRange,
} from './interfaces';

@Component({
  standalone: false,
  selector: 'app-calendar',
  templateUrl: './calendario.component.html',
  styleUrls: ['./calendario.component.scss'],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class CalendarioComponent {
  currentView: 'month' | 'week' = 'month';
  maxVisibleEvents: number = 3;

  @Input() timeRange: ITimeRange = {
    startTime: 9,
    endTime: 17,
    interval: 30,
  };

  @Input() dateRange: IDateRange = {
    startDate: '2025-07-01',
    endDate: '2025-07-31',
  };

  @Input() events: ICalendarEvent[] = [
    {
      id: '1',
      title: 'Daily Stand-up',
      date: '2025-07-21',
      startTime: '09:00',
      endTime: '09:30',
      color: '#3b82f6',
      description: 'Reuni√£o di√°ria da equipe',
    },
    {
      id: '2',
      title: 'Code Review',
      date: '2025-07-21',
      startTime: '10:00',
      endTime: '11:30',
      color: '#8b5cf6',
      description: 'Revis√£o do c√≥digo da nova funcionalidade',
    },
    {
      id: '3',
      title: 'Almo√ßo Cliente',
      date: '2025-07-21',
      startTime: '12:00',
      endTime: '14:00',
      color: '#10b981',
      description: 'Reuni√£o de neg√≥cios',
    },
    {
      id: '4',
      title: 'Apresenta√ß√£o Q2',
      date: '2025-07-21',
      startTime: '15:00',
      endTime: '16:30',
      color: '#f59e0b',
      description: 'Apresenta√ß√£o dos resultados',
    },
    {
      id: '5',
      title: 'Sprint Planning',
      date: '2025-07-22',
      startTime: '09:00',
      endTime: '12:00',
      color: '#ef4444',
      description: 'Planejamento do pr√≥ximo sprint',
    },
    {
      id: '6',
      title: '1:1 com Manager',
      date: '2025-07-22',
      startTime: '14:00',
      endTime: '15:00',
      color: '#6366f1',
      description: 'Conversa individual',
    },
    {
      id: '7',
      title: 'Workshop React',
      date: '2025-07-23',
      startTime: '09:30',
      endTime: '12:30',
      color: '#8b5cf6',
      description: 'Workshop interno',
    },
    {
      id: '8',
      title: 'Dentista',
      date: '2025-07-23',
      startTime: '16:00',
      endTime: '17:00',
      color: '#06b6d4',
      description: 'Consulta odontol√≥gica',
    },
    {
      id: '9',
      title: 'Team Building',
      date: '2025-07-24',
      startTime: '14:00',
      endTime: '18:00',
      color: '#10b981',
      description: 'Atividade de integra√ß√£o',
    },
    {
      id: '10',
      title: 'Deploy Produ√ß√£o',
      date: '2025-07-25',
      startTime: '10:00',
      endTime: '12:00',
      color: '#ef4444',
      description: 'Deploy da nova vers√£o',
    },
    // Eventos adicionais para demonstrar o m√™s
    {
      id: '11',
      title: 'Reuni√£o Mensal',
      date: '2025-07-01',
      startTime: '09:00',
      endTime: '10:00',
      color: '#3b82f6',
      description: 'Reuni√£o mensal da diretoria',
    },
    {
      id: '12',
      title: 'Treinamento',
      date: '2025-07-15',
      startTime: '14:00',
      endTime: '17:00',
      color: '#8b5cf6',
      description: 'Treinamento de novas tecnologias',
    },
    {
      id: '13',
      title: 'Retrospectiva',
      date: '2025-07-31',
      startTime: '15:00',
      endTime: '16:00',
      color: '#f59e0b',
      description: 'Retrospectiva do m√™s',
    },
  ];

  @Input() eventActions: ICalendarAction[] = [
    {
      name: 'üëÅÔ∏è Visualizar',
      method: (event: ICalendarEvent) => this.viewEventDetails(event),
    },
    {
      name: '‚úèÔ∏è Editar',
      method: (event: ICalendarEvent) => this.editEvent(event),
    },
    {
      name: 'üìã Duplicar',
      method: (event: ICalendarEvent) => this.duplicateEvent(event),
    },
    {
      name: 'üîó Compartilhar',
      method: (event: ICalendarEvent) => this.shareEvent(event),
    },
    {
      name: '‚ùå Excluir',
      method: (event: ICalendarEvent) => this.deleteEvent(event),
    },
  ];

  showEventModal: boolean = false;
  showToast: boolean = false;
  toastMessage: string = '';
  modalData: any = null;

  get eventsThisMonth(): number {
    const now = new Date();
    return this.events.filter((event) => {
      const eventDate = new Date(event.date);
      return (
        eventDate.getMonth() === now.getMonth() &&
        eventDate.getFullYear() === now.getFullYear()
      );
    }).length;
  }

  get eventsThisWeek(): number {
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));

    return this.events.filter((event) => {
      const eventDate = new Date(event.date);
      return eventDate >= startOfWeek && eventDate <= endOfWeek;
    }).length;
  }

  setView(view: 'month' | 'week'): void {
    this.currentView = view;
    this.showToastMessage(
      `üì± Visualiza√ß√£o alterada para ${view === 'month' ? 'M√™s' : 'Semana'}`
    );
  }

  onAddEvent(eventData: IAddEventData): void {
    console.log('Adicionando evento:', eventData);

    const newEvent: ICalendarEvent = {
      id: Date.now().toString(),
      title: 'Novo Evento',
      date: eventData.date.toISOString().split('T')[0],
      startTime: eventData.startTime,
      endTime: this.addHoursToTime(eventData.startTime, 1),
      color: this.getRandomColor(),
      description: 'Clique para editar este evento',
    };

    this.events = [...this.events, newEvent];
    this.showToastMessage('‚úÖ Evento criado com sucesso!');
  }

  onViewEvent(event: ICalendarEvent): void {
    console.log('Visualizando evento:', event);
    this.modalData = event;
    this.showEventModal = true;
  }

  onMonthChanged(monthData: { month: string; year: number }): void {
    console.log('M√™s/Per√≠odo alterado:', monthData);
    this.showToastMessage(
      `üìÖ Navegando para ${monthData.month} ${monthData.year}`
    );
  }

  onDayClicked(date: Date): void {
    console.log('Dia clicado:', date);

    const eventsOnDay = this.events.filter((event) => {
      const eventDate = new Date(event.date);
      return eventDate.toDateString() === date.toDateString();
    });

    if (eventsOnDay.length > 0) {
      this.showToastMessage(
        `üìÖ ${eventsOnDay.length} evento(s) em ${date.toLocaleDateString(
          'pt-BR'
        )}`
      );
    } else {
      // Mudar para visualiza√ß√£o semanal neste dia se n√£o houver eventos
      this.currentView = 'week';
      this.showToastMessage(
        `üìä Mudando para visualiza√ß√£o semanal de ${date.toLocaleDateString(
          'pt-BR'
        )}`
      );
    }
  }

  // A√ß√µes do menu de contexto
  viewEventDetails(event: ICalendarEvent): void {
    this.onViewEvent(event);
  }

  editEvent(event: any): void {
    console.log('Editando evento:', event);
    this.modalData = event;
    this.showEventModal = true;
    this.showToastMessage('‚úèÔ∏è Abrindo editor...');
  }

  duplicateEvent(event: ICalendarEvent): void {
    console.log('Duplicando evento:', event);

    const duplicated: ICalendarEvent = {
      ...event,
      id: Date.now().toString(),
      title: `${event.title} (C√≥pia)`,
      startTime: this.addHoursToTime(event.startTime, 1),
      endTime: this.addHoursToTime(event.endTime, 1),
    };

    this.events = [...this.events, duplicated];
    this.showToastMessage('üìã Evento duplicado!');
  }

  shareEvent(event: ICalendarEvent): void {
    console.log('Compartilhando evento:', event);

    const shareText = `üìÖ ${event.title}\nüóìÔ∏è ${event.date}\n‚è∞ ${event.startTime} - ${event.endTime}`;

    if (navigator.share) {
      navigator.share({
        title: event.title,
        text: shareText,
        url: window.location.href,
      });
    } else {
      navigator.clipboard.writeText(shareText);
      this.showToastMessage('üîó Evento copiado para √°rea de transfer√™ncia!');
    }
  }

  deleteEvent(event: ICalendarEvent): void {
    if (confirm(`Tem certeza que deseja excluir "${event.title}"?`)) {
      this.events = this.events.filter((e) => e.id !== event.id);
      this.showToastMessage('‚ùå Evento exclu√≠do!');
    }
  }

  // Modal
  closeEventModal(): void {
    this.showEventModal = false;
    this.modalData = null;
  }

  editEventFromModal(): void {
    this.showToastMessage(
      '‚úèÔ∏è Funcionalidade de edi√ß√£o seria implementada aqui'
    );
    this.closeEventModal();
  }

  // Utilit√°rios
  private addHoursToTime(time: string, hours: number): string {
    const [h, m] = time.split(':').map((n) => parseInt(n, 10));
    const newHour = (h + hours) % 24;
    return `${newHour.toString().padStart(2, '0')}:${m
      .toString()
      .padStart(2, '0')}`;
  }

  private getRandomColor(): string {
    const colors = [
      '#3b82f6',
      '#ef4444',
      '#10b981',
      '#f59e0b',
      '#8b5cf6',
      '#ec4899',
      '#06b6d4',
      '#84cc16',
    ];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  private showToastMessage(message: string): void {
    this.toastMessage = message;
    this.showToast = true;
    setTimeout(() => {
      this.showToast = false;
    }, 3000);
  }

  // M√©todos de demonstra√ß√£o
  exportCalendar(): void {
    const dataStr = JSON.stringify(this.events, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `calendario-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    this.showToastMessage('üì• Calend√°rio exportado!');
  }

  addSampleEvents(): void {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    const sampleEvents: ICalendarEvent[] = [
      {
        id: Date.now().toString(),
        title: 'Reuni√£o de Emerg√™ncia',
        date: today.toISOString().split('T')[0],
        startTime: '16:00',
        endTime: '17:00',
        color: '#ef4444',
        description: 'Reuni√£o urgente sobre projeto X',
      },
      {
        id: (Date.now() + 1).toString(),
        title: 'Caf√© da Manh√£ Equipe',
        date: tomorrow.toISOString().split('T')[0],
        startTime: '08:00',
        endTime: '09:00',
        color: '#10b981',
        description: 'Caf√© da manh√£ casual com a equipe',
      },
    ];

    this.events.push(...sampleEvents);
    this.showToastMessage('üìù Eventos de exemplo adicionados!');
  }

  clearAllEvents(): void {
    if (confirm('Tem certeza que deseja limpar todos os eventos?')) {
      this.events = [];
      this.showToastMessage('üóëÔ∏è Todos os eventos foram removidos!');
    }
  }

  // M√©todos para filtrar eventos por per√≠odo
  filterEventsByPeriod(
    period: 'today' | 'thisWeek' | 'thisMonth' | 'all'
  ): void {
    const now = new Date();

    switch (period) {
      case 'today':
        const today = now.toISOString().split('T')[0];
        this.events = this.events.filter((event) => event.date === today);
        this.showToastMessage('üìÖ Mostrando apenas eventos de hoje');
        break;

      case 'thisWeek':
        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
        const endOfWeek = new Date(
          now.setDate(now.getDate() - now.getDay() + 6)
        );
        this.events = this.events.filter((event) => {
          const eventDate = new Date(event.date);
          return eventDate >= startOfWeek && eventDate <= endOfWeek;
        });
        this.showToastMessage('üìä Mostrando apenas eventos desta semana');
        break;

      case 'thisMonth':
        this.events = this.events.filter((event) => {
          const eventDate = new Date(event.date);
          return (
            eventDate.getMonth() === now.getMonth() &&
            eventDate.getFullYear() === now.getFullYear()
          );
        });
        this.showToastMessage('üìÖ Mostrando apenas eventos deste m√™s');
        break;

      case 'all':
        // Recarregar todos os eventos (normalmente viria de uma API)
        this.showToastMessage('üîÑ Mostrando todos os eventos');
        break;
    }
  }

  // Sincroniza√ß√£o entre visualiza√ß√µes
  syncViewToCurrentDate(): void {
    // Quando mudar de visualiza√ß√£o, manter a data atual sincronizada
    if (this.currentView === 'week') {
      // L√≥gica para sincronizar semana atual
      this.showToastMessage('üîÑ Sincronizando visualiza√ß√£o semanal');
    } else {
      // L√≥gica para sincronizar m√™s atual
      this.showToastMessage('üîÑ Sincronizando visualiza√ß√£o mensal');
    }
  }

  // M√©todos para acessibilidade
  announceViewChange(): void {
    const announcement = `Visualiza√ß√£o alterada para ${
      this.currentView === 'month' ? 'mensal' : 'semanal'
    }.
                         ${this.events.length} eventos carregados.`;

    // Em uma implementa√ß√£o real, voc√™ usaria um servi√ßo de an√∫ncios para screen readers
    console.log('Accessibility announcement:', announcement);
  }

  // M√©todo para debug
  debugCalendarState(): void {
    console.log('=== CALENDAR DEBUG STATE ===');
    console.log('Current View:', this.currentView);
    console.log('Events Count:', this.events.length);
    console.log('Events This Month:', this.eventsThisMonth);
    console.log('Events This Week:', this.eventsThisWeek);
    console.log('Time Range:', this.timeRange);
    console.log('Date Range:', this.dateRange);
    console.log('Max Visible Events (Month):', this.maxVisibleEvents);
    console.log('All Events:', this.events);
  }
}
